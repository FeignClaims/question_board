************************************************************************************************************************
æ–‡ä»¶è¯»å†™
************************************************************************************************************************

é€šè¿‡ :cpp:`#include <fstream>` ä¸­çš„ :cpp:`ofstream`ã€:cpp:`ifstream` å’Œ :cpp:`fstream` æ–‡ä»¶æµ, ä½ å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œå†™å…¥ã€è¯»å–æˆ–è¯»å†™.

å®ƒä»¬çš„ç”¨æ³•äº :cpp:`cout` å’Œ :cpp:`cin` ç›¸ä¼¼, å› æ­¤è¯·å‚è€ƒ :doc:`/faq/input_methods/main` ç­‰äº†è§£. ä»¥ä¸‹è§£é‡Šå¦‚ä½•æ‰“å¼€æ–‡ä»¶ã€è¯»å–åˆ°äº†æ–‡ä»¶æœ«å°¾å’Œå…³é—­æ–‡ä»¶.

========================================================================================================================
æ‰“å¼€æ–‡ä»¶
========================================================================================================================

è¦ä½¿ç”¨æ–‡ä»¶æµ, æˆ‘ä»¬éœ€è¦ç”¨å®ƒå…ˆæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶:

.. code-block:: cpp
  :linenos:

  #include <fstream>
  using namespace std;

  int main() {
    ifstream ifile;
    ifile.open("C:/test.txt", std::ios_base::in);

    // ç„¶åå°±èƒ½åƒ cin ä¸€æ ·ä½¿ç”¨ ifstream
    int value = 0;
    ifile >> value;
  }

è¿™æ ·å°±æ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶, **ä½†æ˜¯ä½•å¿…å‘¢?!**

ä½ æ²¡å¿…è¦æŒ‡æ˜ :cpp:`std::ios_base::in`, :cpp:`ifstream` (input file stream) å§‹ç»ˆä¼šç»™æ–‡ä»¶æ‰“å¼€æ–¹å¼åŠ ä¸Šå®ƒ:

.. code-block:: cpp
  :linenos:

  int main() {
    ifstream ifile;
    ifile.open("C:/test.txt");
  }

ä½ æ²¡å¿…è¦åˆ†å‡ºä¸€è¡Œå†™, å¯ä»¥åœ¨å£°æ˜ :cpp:`ifile` æ—¶å°±è®©å®ƒæ‰“å¼€æ–‡ä»¶:

.. code-block:: cpp
  :linenos:

  int main() {
    ifstream ifile("C:/test.txt");
  }

"å¯æ˜¯æˆ‘ä¹‹å‰çš„å†™æ³•ä¹Ÿæ˜¯å¯ä»¥çš„å•Šâ€¦â€¦"
  1. ä½ å¦‚æœä¸æ˜¯ä¸ºäº†è¯»å–æ–‡ä»¶çš„å†…å®¹, ä½•å¿…ç”¨ :cpp:`ifstream`? æ—¢ç„¶ç”¨ :cpp:`ifstream` å°±æ˜¯æƒ³è¯»å–æ–‡ä»¶å†…å®¹, é‚£ä½•å¿…å†åŠ ä¸€å¥ :cpp:`std::ios_base::in`? **ä½ ç”¨ ifstream, å°±æ˜¯ä¸ºäº†è¯»å–æ–‡ä»¶.**
  2. ä½ å¦‚æœä¸æ˜¯ä¸ºäº†ç°åœ¨æ‰“å¼€è¿™ä¸ªæ–‡ä»¶, ä½•å¿…å»å£°æ˜ :cpp:`ifstream ifile`? æ—¢ç„¶ä½ å£°æ˜ :cpp:`ifstream ifile` å°±æ˜¯è¦æ‰“å¼€æ–‡ä»¶, ä½•å¿…å†åœ¨é¢å¤–ä¸€è¡Œå»å†™ä¸€ä¸ª :cpp:`ifile.open` æ¥æ‰“å¼€æ–‡ä»¶? **ä½ å£°æ˜ ifstream ifile, å°±æ˜¯ä¸ºäº†åœ¨æ­¤æ—¶æ­¤åˆ»æ‰“å¼€æ–‡ä»¶.**

  å†™ä»£ç å¿…é¡»æ³¨æ„ä»£ç çš„ç›®çš„æ€§, æ²¡æœ‰æ˜ç¡®ä»£ç å„éƒ¨åˆ†çš„ç›®çš„æ˜¯å†™ä¸å‡ºä»£ç çš„ç›´æ¥åŸå› ä¹‹ä¸€.

åŒç†, :cpp:`ofstream` ä¼šå§‹ç»ˆåœ¨æ‰“å¼€æ–¹å¼ä¸­åŠ ä¸Š :cpp:`std::ios_base::out`, :cpp:`fstream` ä¼šå§‹ç»ˆåœ¨æ‰“å¼€æ–¹å¼ä¸­åŠ ä¸Š :cpp:`std::ios_base::in | std::ios_base::out`, **å“ªæ€•ä½ ç»™å®ƒå…¶ä»–çš„æ‰“å¼€æ–¹å¼**.

========================================================================================================================
åˆ¤æ–­æ‰“å¼€æˆåŠŸ
========================================================================================================================

é€šè¿‡ :cpp:`ifile.is_open()`, æˆ‘ä»¬å¯ä»¥åˆ¤æ–­ä¸Šä¸€æ¬¡æ‰“å¼€æ–‡ä»¶æ˜¯å¦æˆåŠŸ:

.. code-block:: cpp
  :linenos:

  #include <cstdlib>  // for exit, EXIT_FAILURE, EXIT_SUCCESS

  int main() {
    ifstream ifile("C:/test.txt");
    if (!ifile.is_open()) {
      cerr << "é”™è¯¯ä¿¡æ¯\n";  // err çš„æ„æ€æ˜¯ error
      exit(EXIT_FAILURE);
    }
  }

========================================================================================================================
è¯»å–æ–‡ä»¶åˆ°æœ«å°¾
========================================================================================================================

åœ¨è¯¾ä¸Šå¯èƒ½åƒä¸‹é¢è¿™æ ·å†™, **åƒä¸‡åƒä¸‡åƒä¸‡åƒä¸‡** ä¸è¦ç”¨!!!

.. code-block:: cpp
  :linenos:

  int main() {
    ifstream ifile("C:/test.txt");
    for (int value = 0; !ifile.eof();) {  // æˆ–è€…æœ‰äº›å¥‡æ€ªçš„è€å¸ˆä¼šå†™ ifile.eof() == 0
      ifile >> value;

      cout << value;
    }
  }

æ˜¯, æ²¡é”™, è¿™æ ·æ˜¯å¯ä»¥åˆ¤æ–­æ–‡ä»¶åˆ°æ²¡åˆ°æ–‡ä»¶å°¾ (eof, end of file), ä½†æ˜¯å…¶ä»–é—®é¢˜å‘¢? ä¾‹å¦‚, ç°åœ¨å¾ªç¯é‡Œæ˜¯åœ¨è¯»å– :cpp:`int` ç±»å‹, é‚£å¦‚æœæ–‡ä»¶é‡Œæœ‰ä¸€ä¸ªä¸æ˜¯æ•°å­—çš„å­—ç¬¦å‘¢? **è¯»å–å°†ä¼šå¤±è´¥, ä½ å°†æ°¸è¿œä¸èƒ½è¾¾åˆ°æ–‡ä»¶å°¾, è¿™ä¸ªå¾ªç¯å°†ä¼šæ°¸è¿œç»§ç»­ä¸‹å»**.

.. admonition:: å‰ç½®å†…å®¹
  :class: precontent

  åœ¨å¾€ä¸‹çœ‹æ­£ç¡®çš„æ–¹æ¡ˆä¹‹å‰, è¯·å…ˆé˜…è¯» :doc:`/faq/input_methods/main` ç›´åˆ°è¯»å®Œ "å…±åŒéƒ¨åˆ†".

æ•°æ®è¯»å†™æœ‰ä¸‰ç±»é”™è¯¯çŠ¶æ€: eof (åˆ°è¾¾è¯»å–æ•°æ®çš„å°¾éƒ¨)ã€fail (è¯»å†™æ“ä½œå¤±è´¥)ã€bad (è¯»å†™æµæœ¬èº«å‡ºç°ä¸å¯é€†è½¬çš„é—®é¢˜). **è¯»å†™æ“ä½œå¤±è´¥ fail** æ‰æ˜¯ä½ çœŸæ­£æƒ³è¦çš„, å®ƒæ¶µç›–äº† bad å’Œ eof çš„å‡ ä¹æ‰€æœ‰æƒ…å†µ, å”¯ä¸€æ²¡æ¶µç›–çš„æŸç§ eof æƒ…å†µä¹Ÿä¸æ˜¯ä½ çœŸæ­£æƒ³è¦çš„.

å› æ­¤, æˆ‘ä»¬åº”è¯¥ä½¿ç”¨ :cpp:`!ifile.fail()` æ¥è¡¨è¾¾è¯»å–æœ‰æ²¡æœ‰ç»“æŸ, è€Œ :doc:`/faq/input_methods/main` çš„å…±åŒéƒ¨åˆ†å·²ç»è¯´äº†æ€ä¹ˆå†™:

.. code-block:: cpp
  :linenos:

  int main() {
    ifstream ifile("C:/test.txt");
    if (!ifile.is_open()) {  
      cerr << "æ‰“å¼€æ–‡ä»¶å¤±è´¥!\n";
      exit(EXIT_FAILURE);
    }


    for (int value = 0; ifile >> value;) {
      cout << value;
    }

    if (ifile.bad()) {
      cerr << "è¯»å†™æµæœ¬èº«å‡ºç°ä¸å¯é€†è½¬çš„é—®é¢˜!\n";
      exit(EXIT_FAILURE);
    } else if (ifile.eof()) {
      cout << "æˆåŠŸè¯»å–åˆ°äº†æ–‡ä»¶å°¾!\n";
    } else if (ifile.fail()) {
      cerr << "è¯»å†™æ“ä½œå‡ºç°é—®é¢˜!\n";
      exit(EXIT_FAILURE);
    }
  }

.. note::

  æ³¨æ„, :cpp:`ifile.good() != !ifile.fail()`, å°±åƒä¸‹é¢è¡¨é‡Œåˆ—çš„é‚£æ ·, **ä½†åˆ«å»è®°è¿™ç©æ„**. ä¸Šé¢å·²ç»è¯´äº†, ç”¨ :cpp:`!ifile.fail()`!

  .. figure:: iostate.png

========================================================================================================================
å…³é—­æ–‡ä»¶
========================================================================================================================

å¤ªé•¿åˆ«çœ‹: ä½ ä¸éœ€è¦æ‰‹åŠ¨ç”¨ :cpp:`file.close()` æ¥å…³é—­æ–‡ä»¶, ç”¨è¿™ç§æ–¹å¼åªä¼šè®©äººçŸ¥é“ä½ çœŸçš„ä¸ä¼š C++.

C++ ä¸­çš„å¯¹è±¡å­˜åœ¨ :doc:`ç”Ÿå‘½æœŸå’Œå­˜å‚¨å‘¨æœŸ </faq/lifetime/index>` çš„æ¦‚å¿µ. ç®€å•æ¥è¯´, ä½ åœ¨å¤§æ‹¬å· :cpp:`{}` å†…å£°æ˜çš„å˜é‡, åˆ° :cpp:`}` æ—¶å°±ä¼šæ­»æ‰.

.. code-block:: cpp
  :linenos:

  int main() {
    int value1 = 0;
    cin >> value1;

    if (value != 0) {
      int value2 = value1 * value1;
      cout << value2;
    }  // value2 æ­»æ‰äº†

    cout << value2;  // é”™è¯¯: value2 æ­»éƒ½æ­»äº†, ä½ ä¸å¯èƒ½ç”¨å®ƒ
  }  // value1 æ­»æ‰äº†

å½“ :cpp:`ofstream`ã€:cpp:`ifstream` å’Œ :cpp:`fstream` æ­»æ‰æ—¶, **å®ƒä»¬ä¼šè‡ªåŠ¨å…³é—­æ–‡ä»¶**.

.. code-block:: cpp
  :linenos:

  int main() {
    std::ifstream ifile("C:/test.txt");

    int value = 0;
    ifile >> value;
  }  // ifile æ­»äº†, å®ƒè‡ªåŠ¨å…³é—­æ–‡ä»¶!!!

.. seealso::

  æ–‡ä»¶éœ€è¦æˆ‘ä»¬é¢„å…ˆè·å–ã€ä¹‹åé‡Šæ”¾, å› è€Œæ˜¯ä¸€ç§ "èµ„æº". åœ¨ :doc:`/faq/basic_concepts/resource` ä¸­, æˆ‘è§£é‡Šäº†èµ„æºçš„æ‰€æœ‰æƒé—®é¢˜å’Œ C++ ä¸­èµ„æºçš„æœ€ä½³ç®¡ç†æ–¹æ¡ˆâ€”â€”RAII, è¿™å°±æ˜¯ :cpp:`ofstream`ã€:cpp:`ifstream` å’Œ :cpp:`fstream` é‡‡ç”¨çš„æ–¹æ¡ˆ.

========================================================================================================================
è¯»å†™åŒä¸€ä¸ªæ–‡ä»¶
========================================================================================================================

- æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å¯¹å®ƒè¿›è¡Œå†™å…¥æ—¶, æ˜¯å…ˆå°†æ•°æ®å†™å…¥åˆ°ç¼“å†²åŒº, å†åœ¨åˆé€‚æ—¶å€™ (æ¯”å¦‚) ä¸€æ¬¡æ€§ä»ç¼“å†²åŒºå†™å…¥åˆ°æ–‡ä»¶.
- æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å¯¹å®ƒè¿›è¡Œè¯»å–æ—¶, æ˜¯å…ˆå°†æ–‡ä»¶è¯»å…¥åˆ°ç¼“å†²åŒº, å†ä»ç¼“å†²åŒºä¸­è¯»å–æ•°æ®.

è¿™æ„å‘³ç€, å¦‚æœæˆ‘ä»¬å…ˆç”¨ :cpp:`ofstream` å†™å…¥æ–‡ä»¶, åœ¨ :cpp:`ofstream` è¿˜æ²¡æœ‰å…³é—­æ–‡ä»¶æ—¶, å°±ç”¨ :cpp:`ifstream` å¯è¯»å–åŒä¸€æ–‡ä»¶, é‚£ä¹ˆå¯èƒ½è¯»å–çš„æ˜¯åŸæ¥æ–‡ä»¶ä¸­çš„æ•°æ®.

.. code-block:: cpp
  :linesno:

  int main() {
    ofstream ofile("C:/test.txt");
    ofile << 682132891;

    ifstream ifile("C:/test.txt");
    int value = 0;
    ifile >> value;  // 682132891? è¿˜æ˜¯åˆ«çš„ä»€ä¹ˆ?
  }

"è¿™æ€»èƒ½ç”¨ file.close() äº†å§?" ä½†ä½ è§‰å¾—ä¸‹é¢çš„ä»£ç æ–¹ä¾¿é˜…è¯»å—?

.. code-block:: cpp
  :linesno:

  int main() {
    ofstream ofile("C:/test.txt");
    ofile << 682132891;
    ofile.close();
    ifstream ifile("C:/test.txt");
    int value = 0;
    ifile >> value;
  }

ä½ å¯ä»¥äººä¸ºæ·»åŠ  :cpp:`{}`; æˆ–è€…å¾€å¾€æ›´å¥½åœ°, æ—¢ç„¶æ˜¯å†™å…¥å’Œè¯»å–æ˜¯åœ¨åšä¸åŒçš„äº‹æƒ…, ä¸ºä»€ä¹ˆä¸å†™æˆåˆ†åˆ«çš„å‡½æ•°?

.. tabs::

  .. tab:: äººä¸ºæ·»åŠ  :cpp:`{}`

    .. code-block:: cpp
      :linenos:

      int main() {
        {
          ofstream ofile("C:/test.txt");
          ofile << 682132891;
        }
        {
          ifstream ifile("C:/test.txt");
          int value = 0;
          ifile >> value;
        }
      }

  .. tab:: åˆ†åˆ«çš„å‡½æ•°

    ä¸çŸ¥é“ :cpp:`string` æ˜¯å•¥? :ref:`æ±‚æ±‚ä½ çœ‹å¤©é¹…ä¹¦å§ğŸ˜­ <cpp>`

    .. code-block:: cpp
      :linenos:

      #include <string>  // for string
      using namespace std;

      void write_file(string file) {
        ofstream ofile(file);
        ofile << 682132891;
      }

      void read_file(string file) {
        ifstream ifile(file);
        int value = 0;
        ifile >> value;
      }

      int main() {
        string file = "C:/test.txt";
        write_file(file);
        read_file(file);
      }

å½“ç„¶ä½ å¯ä»¥ç”¨æ—¢èƒ½å†™å…¥åˆèƒ½è¯»å–çš„ :cpp:`fstream`, ä½†æˆ‘è®¤ä¸ºåè€Œè¿‡äºéº»çƒ¦äº†:

.. code-block:: cpp
  :linenos:

  int main() {
    fstream file("C:/test.txt");
    file << 682132891;

    file.seekp(0);  // ä½ èƒ½çœ‹æ‡‚è¿™ä¸ªå‡½æ•°æ˜¯å›åˆ°æ–‡ä»¶å¼€å¤´å—?

    int value = 0;
    ifile >> value;
  }

========================================================================================================================
äºŒè¿›åˆ¶æ–‡ä»¶è¯»å†™
========================================================================================================================

äºŒè¿›åˆ¶æ–‡ä»¶è¯»å†™è§äº :doc:`/faq/binary_io/main`.